OpenTelemetryにコントリビュートしてみた

この記事では、OpenTelemetry JavaScriptのインメモリエクスポータに関する具体的な課題に取り組み、改善した経験を通じて、OSSコントリビュートの魅力やそのハードルの低さをお伝えします。OSSから多くの恩恵を受けてきた私にとって、このコントリビュートは恩返しであると同時に、新たな学びの場でもありました。これを読んだ皆さんが、自分もOSSにコントリビュートしてみようと思えるきっかけになれば幸いです。

# コントリビュートしてみようと思った理由 

趣味で書いている[GitHub Actions OpenTelemetry](https://github.com/paper2/github-actions-opentelemetry)で[opentelemetry-js](https://github.com/open-telemetry/opentelemetry-js)を活用させてもらっています。

利用している中で以前ブログで紹介した[OpenTelemetry JavaScriptのインメモリエクスポータ](https://paper2.hatenablog.com/entry/2024/10/31/085531?_gl=1*pwqhuc*_gcl_au*MTEwNDkxOTU4Mi4xNzM1MDgxOTky)については、テストの不足や一貫性の欠如に使いづらさを感じていました。

以前「OSSには文句ではなく、イシューやプルリクエストを送れ、開発者だろ」的なポストを見かけたことがあります。
私の中では結構心に残っていて、少なくとも上記のブログでも文句のような表現にならないように気をつけて書いていました。

その上で自分もプルリクエストも送ってみるか！というのがきっかけです。

# 使いづらいと感じていたところ

OpenTelemetry JavaScriptの使用中に、インンメモリエクスポータの以下の点で使いづらさを感じていました。ちなみにインンメモリエクスポータはOpenTelemetryの実装のテストに利用する仕組みです。テスト時にメトリクスなどをメモリにエクスポートさせ、その値をテストするのに利用します。

1. スパンのインンメモリエクスポータでスパンデータをリセットする `reset` 関数がテストされていない。そのため利用するのが少し不安。
1. メトリクスのインメモリエクスポータでシャットダウン後もメトリクスデータを取得できる。一方でスパンとログのインメモリエクスポータではシャットダウン後にデータを取得できないため、動作に一貫性がなく利用者を混乱させる。

これらの課題に対して、コミュニティへのコントリビュートとして修正を試みることにしました。コードの修正内容としては小さいのが見えていましたし、初めてやってみる分にはちょうど良いかなと考えていました。

それぞれどのようなプロセスでマージまでされたかを以下で記載します。

## スパンのインンメモリエクスポータでスパンデータをリセットする `reset` 関数がテストされていない

opentelemetry-jsのリポジトリに初めて参加するので、[CONTRIBUTING.md](https://github.com/open-telemetry/opentelemetry-js/blob/main/CONTRIBUTING.md)をまず読みました。 

開発をすぐローカルで始められるようなガイドやプルリクエストを作る際のルールなどが記載されており、ちゃんと仕組み化されていることに感動しました。

この変更ではテストを追加するだけというのもあり最初からプルリクエストを作りました。

https://github.com/open-telemetry/opentelemetry-js/pull/5107

調査として、最初に `reset` 関数が追加された際の[コミット](https://github.com/open-telemetry/opentelemetry-js/commit/c8a37beebaa362225fb52df141247dea4c90f9dd#diff-a96b8cb364904b6cfd28636122f51764e03068778962eaffcd77bb8ede07967e)を確認しました。

最初の実装では `reset` 関数はテストのafterEachセットアップで一貫して使用されていたため、直接テストされていなかったようです。

しかし、[別のコミット](https://github.com/open-telemetry/opentelemetry-js/commit/b884eeca2e4cd6ff544ea44b8f7e4bd4027ceed0) でafterEachセットアップから削除され、テストで一回も登場しないようになってしまったようです。

PRにはそのような背景も添えて、テストを追加しています。

こちらに関しては小さな変更を承認者がぱぱっと修正してくれて、mainにマージされ既にリリースされています。

## メトリクスのインメモリエクスポータでシャットダウン後もメトリクスデータを取得できる

こちらは課題の補足をまずしておきます。

私は今使っているツールでメトリクスとスパンを両方扱っています。メトリクスの方から実装し、シャットダウン後にデータがエクスポートされると考え、シャットダウン後にメトリクスのデータを取得するテストコードを書いていました。

メトリクスではこの方法で成功します。次にスパンを扱った際に同様のテストを書いても成功しないため、理由がなかなかわからず苦戦しました。

デバックをする中で、インメモリエクスポータの挙動がメトリクスとスパンで異なることに気付きました。少なくとも私は利用者として混乱したので、もしかしたら他に困る人もいるかもしれないと考えました。

それではマージまでにやったことを書いていきます。

こちらの課題に関してはまずOpenTelemetryの仕様としてどのように定義されているかを調査しました。

調査した結果、メトリクスエクスポータの仕様としてシャットダウン後にデータを取得できないようにするところまでは[定義していない](https://opentelemetry.io/docs/specs/otel/metrics/sdk/#shutdown-2)ことがわかりました。

そのため実装としては間違っていなそうです。それも踏まえ、以下のイシューを作り、メトリクスのインメモリエクスポータの挙動を合わせることを提案してみました。

https://github.com/open-telemetry/opentelemetry-js/issues/5131

4日後にコントリビュータの一人から「意図的ではないと思う」というコメントをいただきました。

正直実装し始めて良いのかよくわからなかったのですが、まあ大した変更じゃないしプルリクエスト作ってみちゃうか〜というノリで実装をしました。

https://github.com/open-telemetry/opentelemetry-js/pull/5214

PRを作ると自動でopentelemetry-jsの承認者ロールを持った人達にレビュー依頼が飛びます。

インメモリエクスポータの仕様が変わるため最初はCHANGELOG.mdに破壊的変更として記述をしました。

レビュアーに「API変わらないし、破壊的変更じゃないのでは？」と指摘を受けたので修正したら承認をもらえました。

やった〜〜と喜んでいたら、他のレビュアが登場し、「それは破壊的変更だから次のメジャーバージョンに含めて欲しい」とどんでん返しを受けます。

こういうこともあるのね〜と思いながら修正し、現在は次の[メジャーバージョンのSDK 2.0](https://github.com/open-telemetry/opentelemetry-js/tree/next)に変更が取り込まれています。

# 学び

OSSにコントリビュートする過程では、次のような学びがありました。

- 小さな変更でも始められる、挑戦できる
- OSSに複数人がコントリビュートできるための仕組みは重要

前者はタイポ修正から始めようという話であったり、よく言われることではあるかもです。ただ実際にやってみて実感した学びでもあります。

後者は仕組みとして必要な内容などの学びになりました。特にすぐにローカル開発を開始できる過不足ない記述というのはOSSとしてとても重要なんだろうと思いました。

またプルリクエストの承認の流れやコミットメッセージのルールなどが言語化されており、開発しやすかったです。

### 結論

今回の取り組みを通じて、OSSにコントリビュートすることは意外とハードルが低く、多くの学びを得られる貴重な経験であると実感しました。特に、自分が感じた使いづらさを解決することで、他の開発者にも役立つ（と信じたい）変更を加えられたので良かったです。

この記事が、OSSへのコントリビュートを考えている方の参考になり、次の一歩を踏み出すきっかけとなれば嬉しいです。
