OpenTelemetryにコントリビュートしてみた

この記事では、OpenTelemetry JavaScriptのインメモリエクスポータにおける課題を改善した経験を記載します。この記事が、皆さんがOSSに挑戦するきっかけになれば幸いです。

# コントリビュートしてみようと思った理由

趣味で書いている[GitHub Actions OpenTelemetry](https://github.com/paper2/github-actions-opentelemetry)で[opentelemetry-js](https://github.com/open-telemetry/opentelemetry-js)を活用させてもらっています。

利用している中で、以前ブログで紹介した[OpenTelemetry JavaScriptのインメモリエクスポータ](https://paper2.hatenablog.com/entry/2024/10/31/085531?_gl=1*pwqhuc*_gcl_au*MTEwNDkxOTU4Mi4xNzM1MDgxOTky)について、テストの不足に不安を覚え、一貫性の欠如にも使いづらさを感じていました。

以前、「OSSには文句ではなく、イシューやプルリクエストを送れ」という投稿を見かけたことがあります。この投稿は、自分の中で強く印象に残っていました。

そのため、少なくとも上記のブログでも文句のような表現にならないように気をつけて書いていました。

その上で自分もプルリクエスト送ってみるか！と思い、今回挑戦してみました。

# 使いづらいと感じていたところ

インメモリエクスポータの以下の点で使いづらさを感じていました。ちなみにインメモリエクスポータはOpenTelemetryの実装のテストに利用する仕組みです。テスト時にメトリクスなどをメモリにエクスポートさせ、その値をテストするのに利用します。

1. スパンのインメモリエクスポータでスパンデータをリセットする `reset` 関数がテストされていない。そのため利用するのが少し不安。
2. メトリクスのインメモリエクスポータでシャットダウン後もメトリクスデータを取得できる。一方でスパンとログのインメモリエクスポータではシャットダウン後にデータを取得できないため、動作に一貫性がなく利用者を混乱させる。

これらの課題に対して、コミュニティへのコントリビュートとして修正を試みることにしました。コードの修正内容としては小さいのが見えていましたし、初めてやってみる分にはちょうど良いかなと考えていました。

それぞれどのようなプロセスでマージまで進めたかを以下で記載します。

## スパンのインメモリエクスポータでスパンデータをリセットする `reset` 関数がテストされていない

opentelemetry-jsのリポジトリに初めて参加するので、[CONTRIBUTING.md](https://github.com/open-telemetry/opentelemetry-js/blob/main/CONTRIBUTING.md)をまず読みました。

開発をすぐローカルで始められるようなガイドやプルリクエストを作る際のルールなどが記載されており、ちゃんと仕組み化されていることに感動しました。

この変更ではテストを追加するだけというのもあり最初からプルリクエストを作りました。

https://github.com/open-telemetry/opentelemetry-js/pull/5107

調査として、最初に `reset` 関数が追加された際の[コミット](https://github.com/open-telemetry/opentelemetry-js/commit/c8a37beebaa362225fb52df141247dea4c90f9dd#diff-a96b8cb364904b6cfd28636122f51764e03068778962eaffcd77bb8ede07967e)を確認しました。

最初の実装では `reset` 関数はテストのafterEachセットアップで一貫して使用されていたため、直接テストされていなかったようです。

しかし、[別のコミット](https://github.com/open-telemetry/opentelemetry-js/commit/b884eeca2e4cd6ff544ea44b8f7e4bd4027ceed0) でafterEachセットアップから削除され、テストで一回も登場しないようになってしまったようです。

プルリクエストにはそのような背景も添えて、テストを追加しています。

プルリクエストを作ると自動でopentelemetry-jsの承認者ロールを持った人達にレビュー依頼が飛びます。

こちらに関しては小さな変更を承認者がぱぱっと修正してくれて承認をもらえました。

大きめのOSSで初めてのコントリビュートだったので、めちゃくちゃ嬉しかったです！！

現在この変更は既にリリースされており、私のコードが品質維持に役立っているはずです。

## メトリクスのインメモリエクスポータでシャットダウン後もメトリクスデータを取得できる

こちらは課題の補足をまずしておきます。

私は今使っているツールでメトリクスとスパンを両方扱っています。メトリクスの方から実装し、シャットダウン後にデータがエクスポートされると考え、シャットダウン後にメトリクスのデータを取得するテストコードを書いていました。

メトリクスではこの方法で成功します。次にスパンを扱った際に同様のテストを書いても成功しないため、理由がなかなかわからず苦戦しました。

デバッグをする中で、インメモリエクスポータの挙動がメトリクスとスパンで異なることに気付きました。少なくとも私は利用者として混乱したので、もしかしたら他に困る人もいるかもしれないと考えました。

それではマージまでにやったことを書いていきます。

こちらの課題に関してはまずOpenTelemetryの仕様としてどのように定義されているかを調査しました。

調査した結果、メトリクスエクスポータの仕様としてシャットダウン後にデータを取得できないようにするところまでは[定義していない](https://opentelemetry.io/docs/specs/otel/metrics/sdk/#shutdown-2)ことがわかりました。

そのため実装としては間違っていなそうです。それも踏まえ、以下のイシューを作り、メトリクスのインメモリエクスポータの挙動を合わせることを提案してみました。

https://github.com/open-telemetry/opentelemetry-js/issues/5131

4日後にコントリビュータの一人から「意図的ではないと思う」というコメントをいただきました。

正直実装し始めて良いのかよくわからなかったのですが、まあ大した変更じゃないしプルリクエスト作ってみちゃうか〜というノリで実装をしました。

https://github.com/open-telemetry/opentelemetry-js/pull/5214

インメモリエクスポータの仕様が変わるため最初はCHANGELOG.mdに破壊的変更として記述をしました。

レビュアーに「API変わらないし、破壊的変更じゃないのでは？」と指摘を受けたので修正したら承認をもらえました。

やった〜〜と喜んでいたら、他のレビュアが登場し、「それは破壊的変更だから次のメジャーバージョンに含めて欲しい」とどんでん返しを受けます。

こういうこともあるのね〜と思いながら修正し、現在は次の[メジャーバージョンのSDK 2.0](https://github.com/open-telemetry/opentelemetry-js/tree/next)に変更が取り込まれています。

# 学び

OSSにコントリビュートする過程では、次のような学びがありました。

- 小さな変更でも始められる、挑戦できる
  - 例えば、ドキュメントのタイポ修正やテストケースの追加といったシンプルな作業からスタート可能です
  - よく言われることかもしれませんが今回実感できました
- OSSに複数人がコントリビュートできるための仕組みは重要
  - ローカル環境での開発を迅速に始められるガイドやプルリクエストのルール整備などが円滑なコントリビュートを実現するのだろうと思いました
  - 今回開発を始めるハードルは低かったので素晴らしいなと思いました
- レビュアに調査内容なども丁寧に伝えると円滑に進む
  - プルリクエストでのコミュニケーションがメインとなるため背景や意図を明確に言語化して共有することがとても重要だと感じました

### 結論

今回の取り組みを通じて、OSSにコントリビュートすることは意外とハードルが低く、多くの学びを得られる貴重な経験であると実感しました。特に、自分が感じた使いづらさを解決することで、他の開発者にも役立つ（と信じたい）変更を加えられたので良かったです。

この記事が、OSSへのコントリビュートを考えている方の参考になり、次の一歩を踏み出すきっかけとなれば嬉しいです。
